<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LIFF Chat (Chatflow)</title>
  <style>
    :root { --bg:#f7f7f8; --card:#fff; --border:#e5e7eb; --text:#111827; --muted:#6b7280; --primary:#16a34a; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC"; background:var(--bg); color:var(--text); }
    #loginTip { max-width:720px; margin: 20px auto; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; display:none; }
    #log { position: fixed; left:0; right:0; bottom:0; background:#e2e8f0; border-top:1px solid #cbd5e1; font-size:12px; padding:8px 12px; max-height:160px; overflow:auto; display:none; z-index: 9999; }
    .btn { appearance:none; border:1px solid var(--border); background:#fff; padding:10px 14px; border-radius:10px; cursor:pointer; }
    .btn.primary { background:var(--primary); color:#fff; border-color:#10b981; }
  </style>
</head>
<body>
  <div id="loginTip">
    <div style="font-weight:600; margin-bottom:6px;">ç‚ºäº†ä¿å­˜ä½ çš„å°è©±èˆ‡åå¥½ï¼Œå»ºè­°ç™»å…¥ LINE</div>
    <div style="color:#374151; margin-bottom:10px;">å…ˆä¸ç™»å…¥ä¹Ÿèƒ½èŠï¼Œç¨å¾Œéš¨æ™‚å¯ç™»å…¥ä»¥ç¶å®šä½ çš„ç´€éŒ„ã€‚</div>
    <button id="loginBtn" class="btn primary">ä»¥ LINE ç™»å…¥</button>
  </div>
  <div id="log"></div>

  <!-- Flowise å…¨é é¢èŠå¤©å…ƒä»¶ -->
  <flowise-fullchatbot></flowise-fullchatbot>

  <script type="module">
    import Chatbot from "https://cdn.jsdelivr.net/npm/flowise-embed/dist/web.js";

    // å¯é¸ï¼šç¶²å€åŠ  ?liff=1 æ‰å•Ÿç”¨ LIFF
    const LIFF_ID   = "2007994605-MQ7wrXWZ";
    const enableLiff = new URLSearchParams(location.search).get("liff") === "1";

    // ä½ çš„ Chatflow / Flowise è¨­å®š
    const AGENTFLOW_ID = "6b160ef0-db3e-45e4-9292-b8f85262975f";  // é€™è£¡ç”¨ chatflowid
    const FLOWISE_API  = "https://cloud.flowiseai.com";
    const API_KEY      = "iaGjQU5bxYCqxlZ1k5T3l9HUZthwTcghIa96Aks-mNA"; // è‹¥æ²’é–‹ API Key å°±ç•™ç©º ""

    // Debug å°é¢æ¿ï¼ˆç¶²å€åŠ  ?debug=1ï¼‰
    const qs = new URLSearchParams(location.search);
    const showLog = qs.get("debug") === "1";
    const $log = document.getElementById("log");
    const log = (...args) => {
      if (!showLog) return;
      $log.style.display = "block";
      const line = document.createElement("div");
      line.textContent = args.map(x => typeof x === "object" ? JSON.stringify(x) : String(x)).join(" ");
      $log.appendChild(line);
      $log.scrollTop = $log.scrollHeight;
    };
    window.onerror = (m, s, l, c) => log("window.onerror:", m, "@", s, l, c);

    // è®€/å­˜å·¥å…·
    function pick(k){ return sessionStorage.getItem(k) || localStorage.getItem(k) || ""; }
    function put(k,v){ try{ sessionStorage.setItem(k,v); localStorage.setItem(k,v); }catch(e){} }

    // å¾ç¬¬ä¸€é å¸¶ä¾†çš„ç‹€æ…‹
    let mood    = pick("moodLabel") || pick("mood") || "ğŸ™‚";
    let bot     = (pick("bot") || "").toLowerCase(); // "baobao" / "penny"
    let user_id = pick("user_id");

    function startFlowise(sessionId){
      const headers = {};
      if (API_KEY) headers["Authorization"] = "Bearer " + API_KEY;

      // æ ¹æ“šå¿ƒæƒ…å’Œæ©Ÿå™¨äººé¡å‹èª¿æ•´æ­¡è¿è¨Šæ¯
      let welcomeMessage = "å“ˆå›‰ï½ä»Šå¤©æƒ³èŠäº›ä»€éº¼ï¼Ÿ";
      let title = "AI åŠ©æ‰‹";
      
      if (mood && bot) {
        welcomeMessage = `å—¨${user_id ? "ï¼Œ" + user_id : ""}ï¼Œæˆ‘æ˜¯ ${bot || "åŠ©æ‰‹"}ã€‚å…ˆè¨˜ä¸‹ä½ ä»Šå¤©çš„å¿ƒæƒ…ï¼š${mood}ã€‚æƒ³å¾å“ªè£¡é–‹å§‹èŠå‘¢ï¼Ÿ`;
        title = `${bot} - ä»Šå¤©çš„å¿ƒæƒ… ${mood}`;
      } else if (mood) {
        title = `ä»Šå¤©çš„å¿ƒæƒ… ${mood}`;
        welcomeMessage = `ä»Šå¤©çš„å¿ƒæƒ…ï¼š${mood}ã€‚æƒ³èŠäº›ä»€éº¼å‘¢ï¼Ÿ`;
      }

      // â˜… æ”¹ç‚ºä½¿ç”¨ initFull é€²è¡Œå…¨é é¢èŠå¤©
      log("Chatbot.initFull", { chatflowid: AGENTFLOW_ID, apiHost: FLOWISE_API, sessionId, vars:{mood, bot, user_id} });
      
      Chatbot.initFull({
        chatflowid: AGENTFLOW_ID,
        apiHost: FLOWISE_API,
        chatflowConfig: {
          sessionId,
          vars: {
          selectedBot: bot,
          userMood: mood,
          userId: user_id
        }
        },
        observersConfig: {
          /* å¯åœ¨é€™è£¡æ·»åŠ è§€å¯Ÿè€…è¨­å®š */
        },
        headers,
        theme: {
            button: {
                backgroundColor: '#8b56e0',
                right: 20,
                bottom: 20,
                size: 48,
                dragAndDrop: true,
                iconColor: 'white',
                customIconSrc: 'https://raw.githubusercontent.com/walkxcode/dashboard-icons/main/svg/google-messages.svg',
                autoWindowOpen: {
                    autoOpen: true,
                    openDelay: 2,
                    autoOpenOnMobile: false
            }
          },
          tooltip: {
            showTooltip: true,
            tooltipMessage: 'çœ‹çœ‹é€™è£¡ ğŸ‘‹!',
            tooltipBackgroundColor: 'black',
            tooltipTextColor: 'white',
            tooltipFontSize: 16
          },
          disclaimer: {
            title: 'Disclaimer',
            message: "By using this chatbot, you agree to the <a target=\"_blank\" href=\"https://flowiseai.com/terms\">Terms & Condition</a>",
                textColor: 'black',
                buttonColor: '#8b56e0',
                buttonText: 'Start Chatting',
                buttonTextColor: 'white',
                blurredBackgroundColor: 'rgba(0, 0, 0, 0.4)',
                backgroundColor: 'white'
          },
          customCSS: ``,
            chatWindow: {
            
                showTitle: true,
                showAgentMessages: false,
                title: 'å¯¶å¯¶ Bot',
                titleAvatarSrc: 'https://cfedmbn.learnin.work/bauer/hackson/img/baby.png',
                welcomeMessage: 'å“ˆå›‰ï½ä»Šå¤©éå¾—å¦‚ä½•ï¼ŸğŸ˜Š æˆ‘æ˜¯å¯¶å¯¶ï¼Œæœ‰ä»€éº¼äº‹æƒ³åˆ†äº«çš„ï¼Ÿ',
                errorMessage: 'é€™æ˜¯ä¸€å€‹éŒ¯èª¤çš„è¨Šæ¯ï¼',
                backgroundColor: '#ffffff',
                backgroundImage: 'enter image path or link',
                //height: '100%',
                width: '100%',
                fontSize: 16,
                starterPrompts: [
                    "å¯¶å¯¶å¯ä»¥å¹«æˆ‘åšä»€éº¼?",
                    "å¯¶å¯¶åˆ†äº«è·æ¶¯æ–‡ç« "
                ],
            starterPromptFontSize: 15,
            clearChatOnReload: false,
            sourceDocsTitle: 'Sources:',
            renderHTML: true,
            botMessage: {
              backgroundColor: '#f7f8ff',
              textColor: '#303235',
              showAvatar: true,
              avatarSrc: 'https://cfedmbn.learnin.work/bauer/hackson/img/great.png'
            },
            userMessage: {
              backgroundColor: '#3B81F6',
              textColor: '#ffffff',
              showAvatar: true,
              avatarSrc: 'https://cfedmbn.learnin.work/bauer/hackson/img/Mi.png'
            },
            textInput: {
              placeholder: 'ä½ æƒ³èªªçš„è©±',
              backgroundColor: '#ffffff',
              textColor: '#303235',
              sendButtonColor: '#3B81F6',
              maxChars: 50,
              maxCharsWarningMessage: 'You exceeded the characters limit. Please input less than 50 characters.',
              autoFocus: true,
              sendMessageSound: true,
              sendSoundLocation: 'send_message.mp3',
              receiveMessageSound: true,
              receiveSoundLocation: 'receive_message.mp3'
            },
            feedback: {
              color: '#303235'
            },
            dateTimeToggle: {
              date: true,
              time: true
            },
            footer: {
              textColor: '#303235',
              text: 'Powered by',
              company: 'å·¨æ€æ–‡åŒ–è‚¡ä»½æœ‰é™å…¬å¸',
              companyLink: 'https://www.managertoday.com.tw/'
            }
          }
        },
        // å‚³éè‡ªè¨‚è®Šæ•¸çµ¦ Flowise
        customVariables: { mood, bot, user_id }
      });
    }

    async function boot(){
      if (!enableLiff){
        // é LIFFï¼šæ²’æœ‰ user_id å°±ç”¢ç”Ÿä¸€å€‹åŒ¿å ID
        if (!user_id) {
          user_id = (crypto?.randomUUID?.() || ("anon_" + Date.now().toString(36) + Math.random().toString(36).slice(2)));
          put("user_id", user_id);
        }
        startFlowise(`anon_${user_id}`);
        return;
      }

      // LIFFï¼šå‹•æ…‹è¼‰å…¥ä¸¦è™•ç†ç™»å…¥
      log("loading LIFF SDK...");
      const s = document.createElement("script");
      s.src = "https://static.line-scdn.net/liff/edge/2/sdk.js";
      s.onload = async () => {
        try {
          log("init LIFF...");
          await liff.init({ liffId: LIFF_ID });
          if (liff.isLoggedIn()) {
            const profile = await liff.getProfile();
            user_id = profile.userId || user_id || "";
            if (user_id) put("user_id", user_id);
            startFlowise(`line_${user_id || Date.now()}`);
          } else {
            if (!user_id) {
              user_id = (crypto?.randomUUID?.() || ("anon_" + Date.now().toString(36) + Math.random().toString(36).slice(2)));
              put("user_id", user_id);
            }
            startFlowise(`anon_${user_id}`);

            // é¡¯ç¤ºç™»å…¥æç¤º
            const tip = document.getElementById("loginTip");
            const btn = document.getElementById("loginBtn");
            tip.style.display = "block";
            btn.onclick = () => liff.login();
          }
        } catch (err) {
          log("LIFF init error:", err?.message || err);
          if (!user_id) {
            user_id = (crypto?.randomUUID?.() || ("anon_" + Date.now().toString(36) + Math.random().toString(36).slice(2)));
            put("user_id", user_id);
          }
          startFlowise(`anon_${user_id}`);
        }
      };
      s.onerror = () => {
        log("LIFF SDK load error");
        if (!user_id) {
          user_id = (crypto?.randomUUID?.() || ("anon_" + Date.now().toString(36) + Math.random().toString(36).slice(2)));
          put("user_id", user_id);
        }
        startFlowise(`anon_${user_id}`);
      };
      document.head.appendChild(s);
    }

    boot();
  </script>
</body>
</html>
