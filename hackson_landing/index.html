<!DOCTYPE html>
<html lang="zh-TW" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>心情紀錄</title>

  <!-- Tailwind CSS（B 視覺） -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- 若 Tailwind 在 WebView/LIFF 被擋，注入簡易 fallback，保住雙欄與間距 -->
  <script>
  (function () {
    function injectFallback() {
      var css = `
        *{box-sizing:border-box}
        .grid{display:grid}
        .grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}
        .gap-4{gap:1rem}
        .space-y-4>*+*{margin-top:1rem}
        .w-full{width:100%}
        .max-w-md{max-width:28rem}
        .rounded-t-3xl{border-top-left-radius:1.5rem;border-top-right-radius:1.5rem}
        .backdrop-blur-xl{backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px)}
      `;
      var s = document.createElement('style'); s.textContent = css; document.head.appendChild(s);
    }
    function check() {
      var el = document.createElement('div'); el.className = 'hidden';
      document.addEventListener('DOMContentLoaded', function(){
        document.body.appendChild(el);
        var ok = getComputedStyle(el).display === 'none';
        el.remove(); if (!ok) injectFallback();
      });
    }
    check();
  })();
  </script>

  <!-- Google Fonts & Remixicon -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>

  <!-- 你的雲朵等自訂樣式 -->
  <link rel="stylesheet" href="css/styles.css">

  <style>
    :root { --app-vh: 100vh; }
    @supports (height: 100svh) { :root { --app-vh: 100svh; } }
    @supports (height: 100dvh) { :root { --app-vh: 100dvh; } }
    html, body { height: 100%; }
    body { margin: 0; min-height: var(--app-vh); }
    body.min-h-screen { min-height: var(--app-vh) !important; }

    /* 整塊一致的紫色毛玻璃（不用 ::before） */
    #main-card {
      background:
        linear-gradient(0deg, rgba(124,58,237,0.12), rgba(124,58,237,0.12)),
        rgba(255,255,255,0.80);
    }

    .mood-btn, .role-card {
      display:flex; align-items:center; gap:.75rem;
      padding:.875rem 1rem; background:rgba(255,255,255,.9);
      border-radius:1rem; border:1px solid rgba(15,23,42,.08);
      box-shadow:0 4px 14px rgba(2,6,23,.06);
      transition:transform .06s, box-shadow .2s, background .2s, border-color .2s;
    }
    .mood-btn:active, .role-card:active { transform: scale(.98); }
    .mood-btn.sel, .role-card.sel { outline:2px solid #7c3aed; background:#faf5ff; border-color:#e9d5ff; }
    .single-center { width: calc(50% - 0.5rem); margin-left:auto; margin-right:auto; }
  </style>
</head>

<body class="relative">
  <div class="flex flex-col min-h-screen" style="min-height: var(--app-vh);">

    <!-- 背景元素 -->
    <div class="absolute inset-0 z-0">
      <div class="cloud cloud-1"></div>
      <div class="cloud cloud-2"></div>
      <div class="cloud cloud-3"></div>
      <button id="theme-toggle" class="absolute top-10 right-10 w-16 h-16 bg-white/80 rounded-full flex items-center justify-center shadow-lg transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-violet-500">
        <i id="theme-icon" class="ri-moon-clear-fill text-3xl text-violet-500 transition-all duration-500 ease-in-out"></i>
      </button>
    </div>

    <!-- 主要內容卡片 -->
    <main id="main-card" class="mt-auto w-full max-w-md rounded-t-3xl backdrop-blur-xl shadow-2xl p-6 pb-12 sm:p-10 z-10 transition-all duration-500 ease-in-out mx-auto">
      <div class="relative">
        <!-- Step 1 -->
        <section id="mood-section" class="flex flex-col items-center">
          <div class="flex items-center justify-center gap-2 mb-2">
            <i class="ri-sun-line text-xl text-violet-700/80"></i>
            <h1 class="text-xl font-semibold text-violet-700/80">每日心情紀錄</h1>
          </div>
          <h2 class="text-2xl font-semibold text-slate-800 mb-8 tracking-wide">今天感覺如何？</h2>

          <div class="space-y-4 w-full">
            <div class="grid grid-cols-2 gap-4">
              <button class="mood-btn" data-mood="great"><img class="w-12" src="img/great.png" alt="great"><span class="font-medium text-slate-700">很棒</span></button>
              <button class="mood-btn" data-mood="good"><img class="w-12" src="img/happy.png" alt="good"><span class="font-medium text-slate-700">不錯</span></button>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <button class="mood-btn" data-mood="okay"><img class="w-12" src="img/not-great.png" alt="okay"><span class="font-medium text-slate-700">還好</span></button>
              <button class="mood-btn" data-mood="not-great"><img class="w-12" src="img/sad.png" alt="not great"><span class="font-medium text-slate-700">不太好</span></button>
            </div>
            <button class="mood-btn single-center" data-mood="bad">
              <img class="w-12" src="img/bad.png" alt="bad"><span class="font-medium text-slate-700">很糟</span>
            </button>
          </div>
        </section>

        <!-- Step 2（非 absolute，避免高度塌陷） -->
        <section id="role-section" class="hidden flex flex-col items-center">
          <div class="flex items-center justify-center gap-2 mb-2">
            <i class="ri-question-answer-line text-xl text-violet-700/80"></i>
            <h1 class="text-xl font-semibold text-violet-700/80">選擇一位夥伴</h1>
          </div>
          <h2 class="text-2xl font-semibold text-slate-800 mb-8 tracking-wide">想跟誰聊聊呢？</h2>
          <div class="space-y-4 w-full">
            <button class="role-card" data-role="calm">
              <img class="w-12" src="img/calm.png" alt="calm">
              <div class="text-left">
                <h3 class="font-bold text-slate-800">冷靜思考 BOT</h3>
                <p class="text-sm text-slate-500">提供支持與正面能量的夥伴</p>
              </div>
            </button>
            <button class="role-card" data-role="baby">
              <img class="w-12" src="img/baby.png" alt="baby">
              <div class="text-left">
                <h3 class="font-bold text-slate-800">寶寶 (嗚嗚) bot</h3>
                <p class="text-sm text-slate-500">給予陪伴與安慰的三歲寶寶</p>
              </div>
            </button>
            <button id="back-btn" class="mt-4 h-12 flex items-center justify-center gap-2 p-4 rounded-full bg-slate-200/80 hover:bg-slate-300/80 transition-colors w-full">
              <i class="ri-arrow-left-line"></i>
              <span class="font-medium text-slate-600">返回</span>
            </button>
          </div>
        </section>
      </div>
    </main>
  </div>

  <script>
  (function(){
    const CHAT_PAGE = "liff-chat.html";

    const moodSection = document.getElementById("mood-section");
    const roleSection = document.getElementById("role-section");
    const backBtn     = document.getElementById("back-btn");
    const themeBtn    = document.getElementById("theme-toggle");
    const themeIcon   = document.getElementById("theme-icon");

    const moodButtons = Array.from(document.querySelectorAll("#mood-section .mood-btn"));
    const roleButtons = Array.from(document.querySelectorAll("#role-section .role-card"));

    let mood = null;
    let moodLabel = null;
    let bot  = null;

    const ROLE_TO_BOT = { calm: "penny", baby: "baobao" };

    // 產生 / 取得一個穩定的 user_id（若第二頁在 LIFF 內登入，會再覆寫為 LINE userId）
    function ensureUserId(){
      const KEY = "user_id";
      let uid = localStorage.getItem(KEY) || sessionStorage.getItem(KEY);
      if (!uid) {
        uid = (crypto?.randomUUID?.() || ("anon_" + Date.now().toString(36) + Math.random().toString(36).slice(2)));
        try { localStorage.setItem(KEY, uid); sessionStorage.setItem(KEY, uid); } catch(e){}
      }
      return uid;
    }
    const userId = ensureUserId();

    function setSelected(list, target) {
      list.forEach(btn => {
        const sel = btn === target;
        btn.classList.toggle("sel", sel);
        btn.setAttribute("aria-pressed", sel ? "true" : "false");
      });
    }
    function showRole() {
      roleSection.classList.remove("hidden");
      moodSection.classList.add("hidden");
    }
    function showMood() {
      roleSection.classList.add("hidden");
      moodSection.classList.remove("hidden");
    }
    function saveAndGo() {
      try {
        sessionStorage.setItem("user_id", userId);   // ← 追加：保存 user_id
        localStorage.setItem("user_id", userId);

        sessionStorage.setItem("mood", mood);
        sessionStorage.setItem("moodLabel", moodLabel || mood);
        sessionStorage.setItem("bot", bot);

        localStorage.setItem("mood", mood);
        localStorage.setItem("moodLabel", moodLabel || mood);
        localStorage.setItem("bot", bot);
      } catch (e) {}
      location.href = `${CHAT_PAGE}?from=mood`;
    }

    function onMoodPress(e) {
      const t = e.target.closest && e.target.closest("button.mood-btn");
      if (!t) return;
      e.preventDefault();
      mood = t.dataset.mood || null;
      moodLabel = (t.querySelector("span")?.textContent || "").trim() || mood;
      setSelected(moodButtons, t);
      showRole();
    }

    function onRolePress(e) {
      const t = e.target.closest && e.target.closest("button.role-card");
      if (!t) return;
      e.preventDefault();
      const role = t.dataset.role;
      bot = ROLE_TO_BOT[role] || role; // penny / baobao
      setSelected(roleButtons, t);
      if (mood && bot) saveAndGo();
    }

    ["click","touchend"].forEach(evt => {
      moodSection.addEventListener(evt, onMoodPress, { passive:false });
      roleSection.addEventListener(evt, onRolePress, { passive:false });
    });
    backBtn?.addEventListener("click", showMood);

    (function initTheme(){
      const saved = localStorage.getItem("theme");
      if (saved === "dark") document.documentElement.classList.add("dark");
      if (themeIcon) themeIcon.className =
        document.documentElement.classList.contains("dark")
        ? "ri-sun-fill text-3xl text-yellow-400"
        : "ri-moon-clear-fill text-3xl text-violet-500";
    })();

    themeBtn?.addEventListener("click", () => {
      const root = document.documentElement;
      root.classList.toggle("dark");
      const dark = root.classList.contains("dark");
      localStorage.setItem("theme", dark ? "dark" : "light");
      if (themeIcon) themeIcon.className =
        dark ? "ri-sun-fill text-3xl text-yellow-400"
             : "ri-moon-clear-fill text-3xl text-violet-500";
    });
  })();
  </script>
</body>
</html>

